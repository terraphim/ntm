#!/bin/bash
# Fake bv tool for testing
# Supports MODE environment variable: normal (default), timeout, error, schema_drift

MODE="${FAKE_TOOL_MODE:-normal}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
FIXTURES_DIR="$SCRIPT_DIR/../fixtures"

case "$MODE" in
    timeout)
        # Use exec to replace bash with sleep so the process can be killed properly
        # Without exec, sleep becomes a child process that survives when bash is killed
        exec sleep 3600
        ;;
    error)
        echo "bv: simulated error" >&2
        exit 1
        ;;
    schema_drift)
        # Return JSON with unexpected schema
        echo '{"unexpected_field": true, "version": "0.31.0-drift"}'
        exit 0
        ;;
esac

# Normalize: strip leading dashes so both -robot-triage and --robot-triage match
ARG="${1#-}"
ARG="${ARG#-}"

# Normal mode - check arguments
case "$ARG" in
    -version|version)
        echo "bv 0.31.0 (fake)"
        exit 0
        ;;
    robot-triage)
        cat "$FIXTURES_DIR/bv_triage.json" 2>/dev/null || echo '{"generated_at": "2026-01-01T00:00:00Z", "data_hash": "test", "triage": {"meta": {"version": "1.0.0"}, "quick_ref": {"open_count": 10, "actionable_count": 5}}}'
        exit 0
        ;;
    robot-triage-by-label)
        echo '{"generated_at":"2026-01-01T00:00:00Z","triage_by_label":[{"label":"backend","top_pick":{"id":"bd-1","title":"Test"}}]}'
        exit 0
        ;;
    robot-triage-by-track)
        echo '{"generated_at":"2026-01-01T00:00:00Z","triage_by_track":[{"track":"main","top_pick":{"id":"bd-1","title":"Test"}}]}'
        exit 0
        ;;
    robot-plan)
        cat "$FIXTURES_DIR/bv_plan.json" 2>/dev/null || echo '{"generated_at": "2026-01-01T00:00:00Z", "plan": {"tracks": []}}'
        exit 0
        ;;
    robot-insights)
        cat "$FIXTURES_DIR/bv_insights.json" 2>/dev/null || echo '{"generated_at": "2026-01-01T00:00:00Z", "insights": {}}'
        exit 0
        ;;
    robot-next)
        cat "$FIXTURES_DIR/bv_next.json" 2>/dev/null || echo '{"id": "test-1", "title": "Test issue", "command": "bd update test-1 --status in_progress"}'
        exit 0
        ;;
    robot-alerts)
        echo '{"alerts":[{"type":"stale","severity":"warning","message":"Stale issue","issue_id":"bd-1","labels":["backend"]}]}'
        exit 0
        ;;
    robot-graph)
        echo '{"graph":{"nodes":[],"edges":[]},"format":"json"}'
        exit 0
        ;;
    robot-history)
        echo '{"stats":{"total_beads":1,"total_commits":0,"correlated_count":0},"histories":[{"id":"bd-1","title":"Test","events":[]}]}'
        exit 0
        ;;
    robot-burndown)
        echo '{"sprint":"s1","progress":{"total_points":10,"completed_points":4,"percent_complete":40,"days_remaining":3},"scope_changes":[],"at_risk":[]}'
        exit 0
        ;;
    robot-forecast)
        echo '{"forecasts":[{"id":"bd-1","title":"Test issue","estimated_eta":"2026-02-01T00:00:00Z","confidence_level":0.8,"dependency_count":2,"critical_path":true,"blocking_factors":["blocked"]}]}'
        exit 0
        ;;
    robot-suggest)
        echo '{"suggestions":[{"type":"duplicate","description":"Check duplicates","items":["bd-1"]}]}'
        exit 0
        ;;
    robot-impact)
        echo '{"impact_score":0.75,"affected_beads":["bd-1","bd-2"]}'
        exit 0
        ;;
    robot-search)
        echo '{"results":[{"id":"bd-1","title":"Test issue","score":0.9}]}'
        exit 0
        ;;
    robot-label-attention)
        echo '{"labels":[{"name":"backend","score":0.7}]}'
        exit 0
        ;;
    robot-label-flow)
        echo '{"flow_matrix":{"backend":{"frontend":2}},"dependencies":[{"from":"backend","to":"frontend","count":2,"weight":0.5}],"bottleneck_labels":["backend"]}'
        exit 0
        ;;
    robot-label-health)
        echo '{"results":{"labels":[{"label":"backend","health_level":"warning","velocity_score":0.5,"staleness":1.2,"blocked_count":3}]}}'
        exit 0
        ;;
    robot-file-beads)
        echo '{"files":[{"path":"internal/foo.go","beads":["bd-1"]}]}'
        exit 0
        ;;
    robot-file-hotspots)
        echo '{"hotspots":[{"path":"internal/foo.go","score":5}]}'
        exit 0
        ;;
    robot-file-relations)
        echo '{"relations":[{"source":"a.go","target":"b.go","weight":0.8}]}'
        exit 0
        ;;
    help|h)
        echo "bv - Beads Viewer (fake for testing)"
        echo "Usage: bv [options]"
        echo "  --version          Show version"
        echo "  --robot-triage     Get triage recommendations"
        echo "  --robot-plan       Get execution plan"
        echo "  --robot-insights   Get graph insights"
        echo "  --robot-next       Get next work item"
        exit 0
        ;;
    *)
        echo "bv: unknown command: $1" >&2
        exit 1
        ;;
esac
